#!/bin/bash

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
PYTHON_SCRIPT="$SCRIPT_DIR/monitor_process.py"

# æ£€æŸ¥å‚æ•°
if [ -z "$1" ]; then
    echo "Usage:"
    echo "  pwatch <pid>               Monitor an existing process ID in background"
    echo "  pwatch <command> [args]    Run a command and notify when finished"
    exit 1
fi

# æ£€æŸ¥ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦ä¸º PID (çº¯æ•°å­—)
if [[ "$1" =~ ^[0-9]+$ ]]; then
    # === æ¨¡å¼ 1: ç›‘æ§ç°æœ‰ PID ===
    PID=$1
    
    # æ£€æŸ¥ PID æ˜¯å¦å­˜åœ¨
    if ! ps -p $PID > /dev/null; then
        echo "Error: Process $PID does not exist."
        exit 1
    fi

    # åå°å¯åŠ¨ Python ç›‘æ§è„šæœ¬
    # ä½¿ç”¨ nohup å¿½ç•¥æŒ‚èµ·ä¿¡å·ï¼Œé‡å®šå‘è¾“å‡ºåˆ° /dev/null
    nohup python3 "$PYTHON_SCRIPT" "$PID" > /dev/null 2>&1 &
    
    echo "âœ… Monitoring process $PID in the background."
    echo "   You will receive a notification when it ends."

else
    # === æ¨¡å¼ 2: è¿è¡Œæ–°å‘½ä»¤å¹¶é€šçŸ¥ ===
    CMD="$@"
    
    echo "ğŸš€ Running command: $CMD"
    echo "----------------------------------------"
    
    # è®°å½•å¼€å§‹æ—¶é—´
    START_TIME=$(date +%s)
    
    # æ‰§è¡Œå‘½ä»¤
    "$@"
    EXIT_CODE=$?
    
    # è®¡ç®—è€—æ—¶
    END_TIME=$(date +%s)
    DURATION=$((END_TIME - START_TIME))
    
    echo "----------------------------------------"
    echo "Command finished with exit code: $EXIT_CODE"
    
    # æ„å»ºé€šçŸ¥å†…å®¹
    if [ $EXIT_CODE -eq 0 ]; then
        STATUS="Success"
        ICON="âœ…"
    else
        STATUS="Failed"
        ICON="âŒ"
    fi
    
    TITLE="$ICON Command Finished: $1"
    BODY="Command: $CMD\nStatus: $STATUS (Code: $EXIT_CODE)\nDuration: ${DURATION}s"
    
    # å‘é€é€šçŸ¥
    python3 "$PYTHON_SCRIPT" --notify-only --title "$TITLE" --body "$BODY"
fi
